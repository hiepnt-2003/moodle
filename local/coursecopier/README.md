# Course Copier Plugin - Moodle Webservice# Course Copier Plugin for Moodle



Plugin Moodle local ƒë·ªÉ clone/copy kh√≥a h·ªçc v·ªõi JSON API endpoint v√† token authentication.Plugin n√†y cung c·∫•p RESTful API ƒë·ªÉ copy m√¥n h·ªçc trong Moodle v·ªõi c√°c th√¥ng tin t√πy ch·ªânh.



## üéØ T√≠nh nƒÉng ch√≠nh## T√≠nh nƒÉng



- **Clone kh√≥a h·ªçc**: Copy m·ªôt kh√≥a h·ªçc hi·ªán c√≥ v·ªõi th√¥ng tin m·ªõi- Copy m√¥n h·ªçc t·ª´ m·ªôt course hi·ªán c√≥

- **JSON API**: Endpoint nh·∫≠n JSON body v√† tr·∫£ v·ªÅ JSON response  - T√πy ch·ªânh t√™n ƒë·∫ßy ƒë·ªß, t√™n vi·∫øt t·∫Øt, ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c cho course m·ªõi

- **Token Authentication**: H·ªó tr·ª£ Bearer token v√† token trong JSON body- RESTful API c√≥ th·ªÉ test b·∫±ng Postman

- **CORS Support**: Cho ph√©p cross-origin requests- Sao ch√©p to√†n b·ªô n·ªôi dung course (activities, resources, settings)

- **Validation**: Ki·ªÉm tra ƒë·∫ßu v√†o v√† quy·ªÅn truy c·∫≠p ƒë·∫ßy ƒë·ªß

## C√†i ƒë·∫∑t

## üìã Webservice Clone Kh√≥a h·ªçc

1. Copy th∆∞ m·ª•c `coursecopier` v√†o `moodle/local/`

### ƒê·∫ßu v√†o (Input)2. Truy c·∫≠p Administration > Site administration > Notifications ƒë·ªÉ c√†i ƒë·∫∑t plugin

- `shortname_clone`: Shortname c·ªßa kh√≥a h·ªçc ngu·ªìn c·∫ßn clone3. C·∫•u h√¨nh Web Services:

- `fullname`: T√™n ƒë·∫ßy ƒë·ªß c·ªßa kh√≥a h·ªçc m·ªõi   - Administration > Site administration > Plugins > Web services > Overview

- `shortname`: Shortname c·ªßa kh√≥a h·ªçc m·ªõi (ph·∫£i unique)   - Enable web services

- `startdate`: Ng√†y b·∫Øt ƒë·∫ßu (Unix timestamp)   - Enable protocols (REST protocol)

- `enddate`: Ng√†y k·∫øt th√∫c (Unix timestamp)   - Create a service v√† add functions:

     - `local_coursecopier_copy_course`

### ƒê·∫ßu ra (Output)     - `local_coursecopier_get_available_courses`

- `status`: "success" ho·∫∑c "error"

- `id`: ID c·ªßa kh√≥a h·ªçc m·ªõi (0 n·∫øu l·ªói)## API Endpoints

- `message`: Th√¥ng b√°o th√†nh c√¥ng ho·∫∑c m√¥ t·∫£ l·ªói

### 1. Copy Course (JSON REST API - Recommended)

## üöÄ API Endpoints

**Endpoint:** `/local/coursecopier/api.php`

### Base URL

```**Method:** POST

POST /local/coursecopier/api.php

```**Headers:**

- `Content-Type`: application/json

### Authentication- `Authorization`: Bearer {token} (optional, token can also be in body)

H·ªó tr·ª£ 2 c√°ch x√°c th·ª±c:

**JSON Body:**

**1. Authorization Header (Recommend):**```json

```http{

Authorization: Bearer YOUR_TOKEN  "wsfunction": "local_coursecopier_copy_course",

```  "wstoken": "your_token_here", 

  "shortname_clone": "ORIGINAL123",

**2. Token trong JSON body:**  "fullname": "New Course Name",

```json  "shortname": "NEWCOURSE2025",

{  "startdate": 1704067200,

  "wstoken": "YOUR_TOKEN",  "enddate": 1719792000

  ...}

}```

```

### 1.1. Copy Course (Traditional Moodle Web Service)

### Clone Course Request

```http**Endpoint:** `/webservice/rest/server.php`

POST /local/coursecopier/api.php

Content-Type: application/json**Method:** POST

Authorization: Bearer YOUR_TOKEN

**Parameters:**

{- `wstoken`: Web service token

  "wsfunction": "local_coursecopier_clone_course",- `wsfunction`: `local_coursecopier_copy_course`

  "shortname_clone": "COURSE123",- `moodlewsrestformat`: json

  "fullname": "Kh√≥a h·ªçc Clone 2025",- `shortname_clone`: Shortname c·ªßa m√¥n h·ªçc ngu·ªìn c·∫ßn copy

  "shortname": "CLONE2025", - `fullname`: T√™n ƒë·∫ßy ƒë·ªß cho m√¥n h·ªçc m·ªõi

  "startdate": 1704067200,- `shortname`: T√™n vi·∫øt t·∫Øt cho m√¥n h·ªçc m·ªõi

  "enddate": 1719792000- `startdate`: Ng√†y b·∫Øt ƒë·∫ßu (timestamp Unix)

}- `enddate`: Ng√†y k·∫øt th√∫c (timestamp Unix)

```

**Response:**

### Success Response```json

```json{

{  "status": "success",

  "status": "success",  "id": 123,

  "id": 25,  "message": "Copy m√¥n h·ªçc th√†nh c√¥ng! ƒê√£ sao ch√©p to√†n b·ªô n·ªôi dung t·ª´ m√¥n h·ªçc g·ªëc."

  "message": "Copy m√¥n h·ªçc th√†nh c√¥ng! ƒê√£ sao ch√©p to√†n b·ªô n·ªôi dung t·ª´ m√¥n h·ªçc g·ªëc."}

}```

```

**Error Response:**

### Error Response```json

```json{

{  "status": "error",

  "status": "error",  "id": 0,

  "id": 0,  "message": "Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc v·ªõi shortname: ABC123"

  "message": "Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc v·ªõi shortname: COURSE123"}

}```

```

### 2. Get Available Courses (JSON REST API - Recommended)

## üîß C√†i ƒë·∫∑t Plugin

**Endpoint:** `/local/coursecopier/api.php`

### 1. Upload Plugin

```bash**Method:** POST

# Copy plugin v√†o th∆∞ m·ª•c local/

cp -r coursecopier /path/to/moodle/local/**Headers:**

```- `Content-Type`: application/json

- `Authorization`: Bearer {token}

### 2. C√†i ƒë·∫∑t t·ª´ Moodle Admin

1. ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Admin**JSON Body:**

2. V√†o **Site Administration ‚Üí Notifications**```json

3. Click **Upgrade Moodle database now**{

  "wsfunction": "local_coursecopier_get_available_courses",

### 3. C·∫•u h√¨nh Web Services  "wstoken": "your_token_here",

1. **Enable Web Services:**  "categoryid": 0

   - V√†o **Site Administration ‚Üí Advanced features**}

   - Check **Enable web services**```



2. **Enable Protocols:**### 2.1. Get Available Courses (Traditional Moodle Web Service)

   - V√†o **Site Administration ‚Üí Server ‚Üí Web services ‚Üí Manage protocols**

   - Enable **REST protocol****Endpoint:** `/webservice/rest/server.php`



3. **Create Token:****Method:** POST

   - V√†o **Site Administration ‚Üí Server ‚Üí Web services ‚Üí Manage tokens**

   - Click **Create token****Parameters:**

   - Ch·ªçn user v√† service (ho·∫∑c All services)- `wstoken`: Web service token

   - Copy token ƒë·ªÉ s·ª≠ d·ª•ng- `wsfunction`: `local_coursecopier_get_available_courses`

- `moodlewsrestformat`: json

## üìã Test v·ªõi Postman- `categoryid`: ID danh m·ª•c (0 = t·∫•t c·∫£)



### 1. Import Collection**Response:**

Import file `Course_Copier_API.postman_collection.json` v√†o Postman```json

{

### 2. Setup Environment Variables  "courses": [

- `moodle_url`: URL c·ªßa Moodle site (vd: https://yourmoodle.com)    {

- `ws_token`: Web service token t·ª´ Moodle admin      "id": 2,

      "fullname": "Course Example",

### 3. Test Requests      "shortname": "EXAMPLE123",

- **Clone Course**: Test ch√≠nh ƒë·ªÉ clone kh√≥a h·ªçc      "category": 1,

- **Get Available Courses**: L·∫•y danh s√°ch kh√≥a h·ªçc c√≥ th·ªÉ clone      "startdate": 1609459200,

- **Test Invalid Dates**: Test validation v·ªõi ng√†y kh√¥ng h·ª£p l·ªá      "enddate": 1617235200,

      "visible": true

## üîê Capabilities Required    }

  ],

User c·∫ßn c√≥ c√°c quy·ªÅn sau:  "total": 1,

- `moodle/course:create`: T·∫°o kh√≥a h·ªçc m·ªõi  "status": "success",

- `moodle/course:view`: Xem danh s√°ch kh√≥a h·ªçc  "message": "L·∫•y danh s√°ch m√¥n h·ªçc th√†nh c√¥ng"

- `moodle/backup:backupcourse`: Backup kh√≥a h·ªçc ngu·ªìn}

- `moodle/restore:restorecourse`: Restore v√†o kh√≥a h·ªçc m·ªõi```



## üìä HTTP Status Codes## Postman Collection



- `200`: Success### Setup Postman Environment

- `400`: Bad Request (JSON invalid, thi·∫øu parameters)T·∫°o environment v·ªõi variables:

- `401`: Unauthorized (token invalid/expired)- `moodle_url`: URL c·ªßa Moodle site (v√≠ d·ª•: https://yourmoodle.com)

- `405`: Method Not Allowed (ch·ªâ cho ph√©p POST)- `ws_token`: Web service token

- `500`: Internal Server Error

### Test Cases

## üß™ Testing Examples

#### Test 1: Get Available Courses (JSON API)

### cURL Example```json

```bashPOST {{moodle_url}}/local/coursecopier/api.php

curl -X POST "https://yourmoodle.com/local/coursecopier/api.php" \Content-Type: application/json

  -H "Content-Type: application/json" \Authorization: Bearer {{ws_token}}

  -H "Authorization: Bearer YOUR_TOKEN" \

  -d '{{

    "wsfunction": "local_coursecopier_clone_course",  "wsfunction": "local_coursecopier_get_available_courses",

    "shortname_clone": "ORIGINAL123",  "categoryid": 0

    "fullname": "New Course 2025",}

    "shortname": "NEW2025",```

    "startdate": 1704067200,

    "enddate": 1719792000#### Test 2: Copy Course (JSON API)

  }'```json

```POST {{moodle_url}}/local/coursecopier/api.php

Content-Type: application/json

### JavaScript/Fetch ExampleAuthorization: Bearer {{ws_token}}

```javascript

const response = await fetch('/local/coursecopier/api.php', {{

  method: 'POST',  "wsfunction": "local_coursecopier_copy_course",

  headers: {  "shortname_clone": "ORIGINAL123",

    'Content-Type': 'application/json',  "fullname": "New Course Name",

    'Authorization': 'Bearer ' + token  "shortname": "NEWCOURSE123",

  },  "startdate": 1609459200,

  body: JSON.stringify({  "enddate": 1617235200

    wsfunction: 'local_coursecopier_clone_course',}

    shortname_clone: 'ORIGINAL123',```

    fullname: 'New Course 2025',

    shortname: 'NEW2025',#### Test 3: Traditional Web Service (Fallback)

    startdate: 1704067200,```

    enddate: 1719792000POST {{moodle_url}}/webservice/rest/server.php

  })Content-Type: application/x-www-form-urlencoded

});

wstoken={{ws_token}}

const result = await response.json();&wsfunction=local_coursecopier_copy_course

console.log(result);&moodlewsrestformat=json

```&shortname_clone=ORIGINAL123

&fullname=New Course Name

## üêõ Common Issues&shortname=NEWCOURSE123

&startdate=1609459200

1. **"Token is required"**: ƒê·∫£m b·∫£o token ƒë∆∞·ª£c g·ª≠i trong header ho·∫∑c JSON body&enddate=1617235200

2. **"Invalid token"**: Ki·ªÉm tra token c√≥ t·ªìn t·∫°i v√† ch∆∞a h·∫øt h·∫°n```

3. **"JSON body is required"**: ƒê·∫£m b·∫£o Content-Type l√† application/json

4. **"Permission denied"**: User c·∫ßn c√≥ capability t∆∞∆°ng ·ª©ng## Permissions



## üìÅ File StructurePlugin y√™u c·∫ßu c√°c permissions sau:

- `moodle/course:create` - T·∫°o course m·ªõi

```- `moodle/backup:backupcourse` - Backup course

local/coursecopier/- `moodle/restore:restorecourse` - Restore course

‚îú‚îÄ‚îÄ api.php                          # JSON API endpoint ch√≠nh- `moodle/course:view` - Xem danh s√°ch course

‚îú‚îÄ‚îÄ externallib.php                  # External web service functions

‚îú‚îÄ‚îÄ version.php                      # Plugin version info## L∆∞u √Ω

‚îú‚îÄ‚îÄ Course_Copier_API.postman_collection.json # Postman test collection

‚îú‚îÄ‚îÄ README.md                        # Documentation n√†y1. **Timestamps**: S·ª≠ d·ª•ng Unix timestamps cho startdate v√† enddate

‚îú‚îÄ‚îÄ db/2. **Shortname**: Ph·∫£i unique trong h·ªá th·ªëng

‚îÇ   ‚îú‚îÄ‚îÄ access.php                   # Capabilities definition3. **Permissions**: User g·ªçi API ph·∫£i c√≥ ƒë·ªß quy·ªÅn tr√™n course ngu·ªìn v√† system

‚îÇ   ‚îî‚îÄ‚îÄ services.php                 # Web service functions & services4. **Backup/Restore**: Plugin s·ª≠ d·ª•ng Moodle backup/restore API ƒë·ªÉ copy to√†n b·ªô n·ªôi dung

‚îî‚îÄ‚îÄ lang/

    ‚îî‚îÄ‚îÄ en/## Troubleshooting

        ‚îî‚îÄ‚îÄ local_coursecopier.php   # English language strings

```### L·ªói th∆∞·ªùng g·∫∑p:



## üèóÔ∏è Technical Details1. **"Web service not enabled"**: K√≠ch ho·∫°t web services trong Administration

2. **"Invalid token"**: Ki·ªÉm tra token v√† user permissions

- **Moodle Version**: 3.10+3. **"Capability required"**: User c·∫ßn c√≥ ƒë·ªß permissions

- **PHP Version**: 7.4+4. **"Course not found"**: Ki·ªÉm tra shortname_clone c√≥ t·ªìn t·∫°i kh√¥ng

- **Plugin Type**: Local plugin

- **Database**: S·ª≠ d·ª•ng Moodle backup/restore API### Debug mode:

- **Security**: Token authentication, capability checks, input validationEnable debugging trong Moodle ƒë·ªÉ xem chi ti·∫øt l·ªói:

`Administration > Site administration > Development > Debugging`

## üìû Support

## T√°c gi·∫£

N·∫øu c√≥ v·∫•n ƒë·ªÅ v·ªõi plugin:

1. Ki·ªÉm tra Moodle logs t·∫°i **Site Administration ‚Üí Reports ‚Üí Logs**Plugin ƒë∆∞·ª£c ph√°t tri·ªÉn cho Moodle 3.10+

2. Ki·ªÉm tra Web service logs t·∫°i **Site Administration ‚Üí Development ‚Üí Web service test client**

3. Ensure backup/restore capabilities are properly configured## License



---GNU GPL v3 or later

**Plugin Version**: v1.0  
**Compatible**: Moodle 3.10+  
**License**: GPL v3 or later