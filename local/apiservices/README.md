# API Services - Moodle Web Services Plugin

## Overview

Plugin **API Services** cung c·∫•p c√°c web services API ƒë·ªÉ qu·∫£n l√Ω Course v√† User trong Moodle. Plugin n√†y g·ªôp ch·ª©c nƒÉng c·ªßa 2 services:
- **Course Copy Service** - Copy m√¥n h·ªçc v·ªõi th√¥ng tin m·ªõi
- **User Creation Service** - T·∫°o ng∆∞·ªùi d√πng m·ªõi

## Features

### 1. Course Copy API
- Copy ƒë·∫ßy ƒë·ªß n·ªôi dung m√¥n h·ªçc t·ª´ m·ªôt m√¥n h·ªçc ngu·ªìn v·ªõi c√°c th√¥ng tin m·ªõi
- Gi·ªØ nguy√™n c·∫•u tr√∫c, c√†i ƒë·∫∑t v√† format c·ªßa m√¥n h·ªçc ngu·ªìn
- T·ª± ƒë·ªông sao ch√©p t·∫•t c·∫£:
  - Activities (b√†i t·∫≠p, quiz, forum, v.v.)
  - Resources (files, pages, URLs, v.v.)
  - Blocks
  - Sections v√† course format options
  - Role assignments v√† users
  - Comments, badges, calendar events
  - User completion data
- S·ª≠ d·ª•ng Moodle Backup/Restore API ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn

### 2. User Creation API
- T·∫°o ng∆∞·ªùi d√πng m·ªõi v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin
- H·ªó tr·ª£ t·ª± ƒë·ªông t·∫°o password ho·∫∑c t·ª± ƒë·ªãnh nghƒ©a
- Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa username, email v√† password

## Architecture - Ki·∫øn tr√∫c h·ªá th·ªëng

### Request Flow

```
Client (Postman/App)
    ‚Üì HTTP POST Request
[RESTful Server] (webservice/restful/server.php/{function_name})
    ‚Üì Validate Token
[Web Services API] (Moodle Core)
    ‚Üì Route to Function
[External Functions] (externallib.php)
    ‚Üì Validate Parameters & Capabilities
[Business Logic]
    ‚îú‚îÄ Course Copy: Backup/Restore API
    ‚îî‚îÄ User Create: User Management API
    ‚Üì Database Operations
[Moodle Database]
    ‚Üì Return Result
[Response] JSON Format
    ‚Üì
Client receives response
```

### Security Layers

1. **Token Authentication**
   - M·ªói request ph·∫£i c√≥ token h·ª£p l·ªá trong header
   - Token ƒë∆∞·ª£c t·∫°o t·ª´ Web Services settings

2. **Capability Checks**
   - Course Copy: Y√™u c·∫ßu `moodle/course:create`
   - User Create: Y√™u c·∫ßu `moodle/user:create`

3. **Parameter Validation**
   - Validate type, format, required fields
   - S·ª≠ d·ª•ng `external_function_parameters`

4. **Context Validation**
   - Validate context level (system, course, module)
   - Ensure user has access to context

5. **Database Transactions**
   - Atomic operations ƒë·ªÉ ƒë·∫£m b·∫£o data integrity
   - Rollback n·∫øu c√≥ l·ªói

## Installation

1. Copy th∆∞ m·ª•c `apiservices` v√†o th∆∞ m·ª•c `local/` c·ªßa Moodle
2. Truy c·∫≠p Site Administration ‚Üí Notifications ƒë·ªÉ c√†i ƒë·∫∑t plugin
3. C·∫•u h√¨nh Web Services theo h∆∞·ªõng d·∫´n trong [SETUP_GUIDE.md](SETUP_GUIDE.md)

## Workflow - Lu·ªìng ho·∫°t ƒë·ªông

### üîÑ Course Copy Workflow

```mermaid
graph TD
    A[Client g·ª≠i API Request] --> B[Validate Parameters]
    B --> C{Parameters h·ª£p l·ªá?}
    C -->|Kh√¥ng| D[Tr·∫£ v·ªÅ Error]
    C -->|C√≥| E[Ki·ªÉm tra quy·ªÅn: moodle/course:create]
    E --> F{C√≥ quy·ªÅn?}
    F -->|Kh√¥ng| D
    F -->|C√≥| G[T√¨m m√¥n h·ªçc ngu·ªìn theo shortname_clone]
    G --> H{T√¨m th·∫•y?}
    H -->|Kh√¥ng| D
    H -->|C√≥| I[Ki·ªÉm tra shortname m·ªõi ƒë√£ t·ªìn t·∫°i?]
    I --> J{ƒê√£ t·ªìn t·∫°i?}
    J -->|C√≥| D
    J -->|Kh√¥ng| K[T·∫°o m√¥n h·ªçc m·ªõi r·ªóng]
    K --> L[Backup m√¥n h·ªçc ngu·ªìn]
    L --> M[Restore n·ªôi dung v√†o m√¥n h·ªçc m·ªõi]
    M --> N[C·∫≠p nh·∫≠t th√¥ng tin m√¥n h·ªçc m·ªõi]
    N --> O[D·ªçn d·∫πp file backup t·∫°m]
    O --> P[Tr·∫£ v·ªÅ Success + Course ID]
    
    D --> Q[Response Error]
    P --> R[Response Success]
```

#### Chi ti·∫øt c√°c b∆∞·ªõc:

1. **Validate Parameters** (B∆∞·ªõc 1)
   - Ki·ªÉm tra shortname_clone, fullname, shortname kh√¥ng tr·ªëng
   - Validate startdate v√† enddate l√† timestamp h·ª£p l·ªá
   - Ki·ªÉm tra enddate > startdate

2. **Check Capabilities** (B∆∞·ªõc 2)
   - Y√™u c·∫ßu quy·ªÅn `moodle/course:create`
   - Context: System level

3. **Find Source Course** (B∆∞·ªõc 3)
   - Query database: `SELECT * FROM {course} WHERE shortname = ?`
   - N·∫øu kh√¥ng t√¨m th·∫•y ‚Üí Error

4. **Check Shortname Uniqueness** (B∆∞·ªõc 4)
   - Query: `SELECT * FROM {course} WHERE shortname = ?`
   - N·∫øu ƒë√£ t·ªìn t·∫°i ‚Üí Error

5. **Create Empty Course** (B∆∞·ªõc 5)
   - S·ª≠ d·ª•ng `create_course()` API
   - Copy c√°c thu·ªôc t√≠nh t·ª´ m√¥n h·ªçc ngu·ªìn (category, format, visible, etc.)
   - Set fullname, shortname, startdate, enddate m·ªõi

6. **Backup Source Course** (B∆∞·ªõc 6)
   - S·ª≠ d·ª•ng Moodle Backup API: `backup_controller`
   - Backup type: `TYPE_1COURSE`
   - Format: `FORMAT_MOODLE`
   - Mode: `MODE_GENERAL`
   - Backup to√†n b·ªô: Activities, Resources, Blocks, Users, Roles, Comments, Badges, Calendar events

7. **Restore to New Course** (B∆∞·ªõc 7)
   - S·ª≠ d·ª•ng Moodle Restore API: `restore_controller`
   - Target: `TARGET_CURRENT_ADDING` (th√™m v√†o course ƒë√£ t·∫°o)
   - Execute precheck tr∆∞·ªõc khi restore
   - Restore to√†n b·ªô n·ªôi dung

8. **Update Course Info** (B∆∞·ªõc 8)
   - Update l·∫°i startdate, enddate, fullname, shortname
   - ƒê·∫£m b·∫£o th√¥ng tin ch√≠nh x√°c

9. **Cleanup** (B∆∞·ªõc 9)
   - X√≥a file backup t·∫°m trong temp directory
   - Release resources

10. **Return Result**
    - Success: `{status: "success", id: course_id, message: "..."}`
    - Error: `{status: "error", id: 0, message: "error_description"}`

---

### üë§ User Creation Workflow

```mermaid
graph TD
    A[Client g·ª≠i API Request] --> B[Validate Parameters]
    B --> C{Parameters h·ª£p l·ªá?}
    C -->|Kh√¥ng| D[Tr·∫£ v·ªÅ Error]
    C -->|C√≥| E[Ki·ªÉm tra quy·ªÅn: moodle/user:create]
    E --> F{C√≥ quy·ªÅn?}
    F -->|Kh√¥ng| D
    F -->|C√≥| G[Ki·ªÉm tra username ƒë√£ t·ªìn t·∫°i?]
    G --> H{ƒê√£ t·ªìn t·∫°i?}
    H -->|C√≥| D
    H -->|Kh√¥ng| I[Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i?]
    I --> J{ƒê√£ t·ªìn t·∫°i?}
    J -->|C√≥| D
    J -->|Kh√¥ng| K{createpassword = true?}
    K -->|C√≥| L[Generate random password]
    K -->|Kh√¥ng| M[Validate password strength]
    M --> N{Password ƒë·ªß m·∫°nh?}
    N -->|Kh√¥ng| D
    N -->|C√≥| O[Hash password]
    L --> O
    O --> P[Insert user v√†o database]
    P --> Q[Trigger user_created event]
    Q --> R[Tr·∫£ v·ªÅ Success + User ID]
    
    D --> S[Response Error]
    R --> T[Response Success]
```

#### Chi ti·∫øt c√°c b∆∞·ªõc:

1. **Validate Parameters** (B∆∞·ªõc 1)
   - Ki·ªÉm tra username, firstname, lastname, email kh√¥ng tr·ªëng
   - Validate username format: `^[a-zA-Z0-9._-]+$`
   - Validate email format: ph·∫£i l√† email h·ª£p l·ªá

2. **Check Capabilities** (B∆∞·ªõc 2)
   - Y√™u c·∫ßu quy·ªÅn `moodle/user:create`
   - Context: System level

3. **Check Username Uniqueness** (B∆∞·ªõc 3)
   - Query: `SELECT * FROM {user} WHERE username = ?`
   - N·∫øu ƒë√£ t·ªìn t·∫°i ‚Üí Error

4. **Check Email Uniqueness** (B∆∞·ªõc 4)
   - Query: `SELECT * FROM {user} WHERE email = ?`
   - N·∫øu ƒë√£ t·ªìn t·∫°i ‚Üí Error

5. **Handle Password** (B∆∞·ªõc 5)
   - **N·∫øu createpassword = true**:
     - Generate random password (12 k√Ω t·ª±)
     - Bao g·ªìm: a-z, A-Z, 0-9, !@#$%^&*
   - **N·∫øu createpassword = false**:
     - Validate password strength:
       - T·ªëi thi·ªÉu 8 k√Ω t·ª±
       - C√≥ √≠t nh·∫•t 1 ch·ªØ th∆∞·ªùng
       - C√≥ √≠t nh·∫•t 1 ch·ªØ hoa
       - C√≥ √≠t nh·∫•t 1 ch·ªØ s·ªë
     - N·∫øu kh√¥ng ƒë·ªß m·∫°nh ‚Üí Error

6. **Hash Password** (B∆∞·ªõc 6)
   - S·ª≠ d·ª•ng `hash_internal_user_password()`
   - Moodle s·ª≠ d·ª•ng bcrypt ƒë·ªÉ hash

7. **Create User Record** (B∆∞·ªõc 7)
   - Prepare user object:
     ```php
     {
         username, firstname, lastname, email,
         password: hashed_password,
         confirmed: 1,
         mnethostid: CFG->mnet_localhost_id,
         auth: 'manual',
         timecreated: time(),
         timemodified: time()
     }
     ```
   - Insert v√†o b·∫£ng `{user}`

8. **Trigger Event** (B∆∞·ªõc 8)
   - Fire `\core\event\user_created` event
   - Cho ph√©p c√°c plugin kh√°c hook v√†o

9. **Return Result**
   - Success: `{status: "success", id: user_id, message: "User has been successfully created"}`
   - Error: `{status: "error", id: 0, message: "error_description"}`

---

## API Endpoints
**Function:** `local_apiservices_copy_course`

**Parameters:**
- `shortname_clone` (string) - Shortname c·ªßa m√¥n h·ªçc ngu·ªìn c·∫ßn copy
- `fullname` (string) - T√™n ƒë·∫ßy ƒë·ªß cho m√¥n h·ªçc m·ªõi
- `shortname` (string) - T√™n vi·∫øt t·∫Øt cho m√¥n h·ªçc m·ªõi
- `startdate` (int) - Ng√†y b·∫Øt ƒë·∫ßu (Unix timestamp)
- `enddate` (int) - Ng√†y k·∫øt th√∫c (Unix timestamp)

**Returns:**
```json
{
    "status": "success",
    "id": 123,
    "message": "Copy ƒë·∫ßy ƒë·ªß n·ªôi dung m√¥n h·ªçc th√†nh c√¥ng! ID m√¥n h·ªçc m·ªõi: 123"
}
```

### 2. Create User
**Function:** `local_apiservices_create_user`

**Parameters:**
- `username` (string) - Username cho ng∆∞·ªùi d√πng m·ªõi
- `firstname` (string) - T√™n
- `lastname` (string) - H·ªç
- `email` (string) - ƒê·ªãa ch·ªâ email
- `createpassword` (boolean) - T·ª± ƒë·ªông t·∫°o password hay kh√¥ng
- `password` (string) - Password (b·∫Øt bu·ªôc n·∫øu createpassword = false)

**Returns:**
```json
{
    "status": "success",
    "id": 456,
    "message": "User has been successfully created"
}
```

## Testing

S·ª≠ d·ª•ng Postman collection ƒë√£ ƒë∆∞·ª£c cung c·∫•p trong file `API_Services.postman_collection.json` ƒë·ªÉ test c√°c API endpoints.

### RESTful Protocol

Plugin n√†y s·ª≠ d·ª•ng **webservice_restful** protocol c·ªßa Moodle:

**Endpoint Format**: `{{moodle_url}}/webservice/restful/server.php/{function_name}`

**Headers b·∫Øt bu·ªôc**:
- `Authorization`: YOUR_TOKEN (kh√¥ng c·∫ßn 'Bearer' prefix)
- `Content-Type`: application/json
- `Accept`: application/json

**Body**: JSON format v·ªõi c√°c parameters

### Example Requests

#### 1. Copy Course Example

```bash
POST http://localhost/my/webservice/restful/server.php/local_apiservices_copy_course
Authorization: abc123def456token789
Content-Type: application/json

{
    "shortname_clone": "CS101",
    "fullname": "Introduction to Computer Science - Spring 2025",
    "shortname": "CS101-S2025",
    "startdate": 1704067200,
    "enddate": 1719792000
}
```

**Response Success:**
```json
{
    "status": "success",
    "id": 45,
    "message": "Copy ƒë·∫ßy ƒë·ªß n·ªôi dung m√¥n h·ªçc th√†nh c√¥ng! ID m√¥n h·ªçc m·ªõi: 45"
}
```

**Response Error:**
```json
{
    "status": "error",
    "id": 0,
    "message": "Shortname ƒë√£ t·ªìn t·∫°i: CS101-S2025"
}
```

#### 2. Create User Example

```bash
POST http://localhost/my/webservice/restful/server.php/local_apiservices_create_user
Authorization: abc123def456token789
Content-Type: application/json

{
    "username": "johndoe",
    "firstname": "John",
    "lastname": "Doe",
    "email": "john.doe@example.com",
    "createpassword": false,
    "password": "SecurePass123!"
}
```

**Response Success:**
```json
{
    "status": "success",
    "id": 156,
    "message": "User has been successfully created"
}
```

**Response Error:**
```json
{
    "status": "error",
    "id": 0,
    "message": "Username ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng: johndoe"
}
```

### Common Error Responses

| Error Message | Nguy√™n nh√¢n | Gi·∫£i ph√°p |
|---------------|-------------|-----------|
| `Invalid token` | Token kh√¥ng h·ª£p l·ªá ho·∫∑c h·∫øt h·∫°n | T·∫°o token m·ªõi t·ª´ Web Services |
| `Access control exception` | Thi·∫øu quy·ªÅn (capability) | G√°n quy·ªÅn cho user ho·∫∑c role |
| `Shortname ƒë√£ t·ªìn t·∫°i` | Course shortname ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng | ƒê·ªïi shortname kh√°c |
| `Username ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng` | Username ƒë√£ t·ªìn t·∫°i | ƒê·ªïi username kh√°c |
| `Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng` | Email ƒë√£ t·ªìn t·∫°i | ƒê·ªïi email kh√°c |
| `Password kh√¥ng ƒë·ªß m·∫°nh` | Password kh√¥ng ƒë√°p ·ª©ng y√™u c·∫ßu | ƒê·∫£m b·∫£o password c√≥ 8+ k√Ω t·ª±, ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë |
| `Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu` | enddate <= startdate | Ki·ªÉm tra l·∫°i timestamp |

## Documentation

- [Setup Guide](SETUP_GUIDE.md) - H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t v√† c·∫•u h√¨nh chi ti·∫øt
- [API Overview](OVERVIEW.md) - T·ªïng quan v·ªÅ c√°c API
- [RESTful Protocol Guide](RESTFUL_GUIDE.md) - H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng RESTful protocol
- [Postman Collection](API_Services.postman_collection.json) - Collection ƒë·ªÉ test APIs

## Requirements

- Moodle 3.8 tr·ªü l√™n
- Web Services ƒë∆∞·ª£c k√≠ch ho·∫°t
- RESTful protocol ƒë∆∞·ª£c k√≠ch ho·∫°t (webservice_restful plugin)

## Performance Considerations

### Course Copy Performance

| Course Size | Estimated Time | Notes |
|-------------|----------------|-------|
| Small (< 50 activities) | 30-60 gi√¢y | Nhanh, ph√π h·ª£p cho real-time |
| Medium (50-200 activities) | 1-3 ph√∫t | N√™n ch·∫°y async ho·∫∑c background |
| Large (> 200 activities) | 3-10 ph√∫t | B·∫Øt bu·ªôc background job |

**Factors affecting performance:**
- S·ªë l∆∞·ª£ng activities v√† resources
- K√≠ch th∆∞·ªõc files trong course
- User data (enrollments, grades, completion)
- Server resources (CPU, RAM, disk I/O)

**Optimization tips:**
- Ch·∫°y course copy trong off-peak hours
- TƒÉng PHP memory limit n·∫øu c·∫ßn (recommend: 512MB+)
- TƒÉng PHP max_execution_time (recommend: 300s+)
- S·ª≠ d·ª•ng cache backend nhanh (Redis/Memcached)

### User Creation Performance

- **Single user**: < 1 gi√¢y
- **Bulk users**: N√™n s·ª≠ d·ª•ng batch processing
- **Rate limiting**: Recommend max 100 users/minute ƒë·ªÉ tr√°nh overload

## Best Practices

### 1. Token Management
```php
// ‚úÖ DO: Store token securely
$token = getenv('MOODLE_API_TOKEN');

// ‚ùå DON'T: Hardcode token in code
$token = 'abc123def456';
```

### 2. Error Handling
```javascript
// ‚úÖ DO: Handle errors gracefully
try {
    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(params)
    });
    
    const result = await response.json();
    
    if (result.status === 'error') {
        console.error('API Error:', result.message);
        // Handle error appropriately
    } else {
        console.log('Success:', result.message);
    }
} catch (error) {
    console.error('Network Error:', error);
}
```

### 3. Timestamp Handling
```javascript
// ‚úÖ DO: Use proper timestamp conversion
const startDate = new Date('2025-01-01');
const startTimestamp = Math.floor(startDate.getTime() / 1000);

// ‚ùå DON'T: Use JavaScript timestamp directly (milliseconds)
const wrongTimestamp = Date.now(); // This is in milliseconds!
```

### 4. Course Copy Strategy
```
// ‚úÖ DO: Verify source course exists first
1. GET course info by shortname
2. Validate source course accessible
3. Call copy_course API

// ‚ùå DON'T: Call copy_course blindly
1. Call copy_course API directly (may waste resources)
```

### 5. Batch Operations
```python
# ‚úÖ DO: Use batch processing for multiple operations
import time

users = [...]  # List of users to create

for user in users:
    create_user(user)
    time.sleep(0.1)  # Rate limiting: 10 users/second

# ‚ùå DON'T: Fire all requests simultaneously
for user in users:
    create_user(user)  # May overload server
```

## Troubleshooting

### Issue: "Invalid token"
**Causes:**
- Token expired
- Token not activated
- Wrong token value

**Solutions:**
1. Check token exists: Site admin ‚Üí Web services ‚Üí Manage tokens
2. Verify token is enabled
3. Recreate token if necessary

### Issue: "Access control exception"
**Causes:**
- User doesn't have required capability
- Service not enabled for user

**Solutions:**
1. Grant capability to user/role:
   - `moodle/course:create` for course copy
   - `moodle/user:create` for user creation
2. Enable service for user in Web Services ‚Üí Authorised users

### Issue: Course copy timeout
**Causes:**
- Course too large
- PHP execution timeout
- Server resources exhausted

**Solutions:**
1. Increase PHP settings:
   ```ini
   max_execution_time = 300
   memory_limit = 512M
   ```
2. Consider using Moodle scheduled task instead
3. Copy smaller courses or reduce content

### Issue: "Database error" during operations
**Causes:**
- Database connection issues
- Constraint violations
- Transaction conflicts

**Solutions:**
1. Check Moodle logs: Site admin ‚Üí Reports ‚Üí Logs
2. Check database server status
3. Verify database constraints (unique keys, foreign keys)
4. Retry operation after brief delay

## Monitoring & Logging

### Enable detailed logging

```php
// In config.php
$CFG->debug = DEBUG_DEVELOPER;
$CFG->debugdisplay = 0; // Don't display errors to users
$CFG->debugstringids = 0;

// Log all web service calls
$CFG->webservicelogging = 1;
```

### Check logs

1. **Web service logs**: Site admin ‚Üí Reports ‚Üí Web service usage
2. **System logs**: Site admin ‚Üí Reports ‚Üí Logs
3. **PHP error logs**: Check server PHP error log file

### Metrics to monitor

- **API response time**: Should be < 5s for normal operations
- **Error rate**: Should be < 1% in production
- **Success rate**: Should be > 99%
- **Resource usage**: Monitor CPU, RAM, disk I/O during copy operations

## License

This plugin is licensed under the GNU GPL v3 or later.

## Support

ƒê·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£, vui l√≤ng t·∫°o issue ho·∫∑c li√™n h·ªá v·ªõi ƒë·ªôi ph√°t tri·ªÉn.
